---
title: How to update to CIS AWS Foundations Benchmark v1.4.0
categories: Upgrades
image: /assets/img/guides/refresh_icon.png
excerpt: Learn how to update to version 1.4.0 of the CIS AWS Foundations Benchmark
tags: ["aws", "security", "compliance"]
cloud: ["aws"]
redirect_from: /static/guides/upgrades/how-to-update-to-cis-1.4/
---
:page-type: guide
:page-layout: post

:toc:
:toc-placement!:

// GitHub specific settings. See https://gist.github.com/dcode/0cfbf2699a1fe9b46ff04c41721dda74 for details.
ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
toc::[]
endif::[]

== Intro

This guide will walk you through the process of updating version 1.3.0 to version 1.4.0 of the CIS AWS Foundations Benchmark.
If your infrastructure is already compliant with v1.3.0, and you are looking to upgrade to v1.4.0,
then this guide is for you. Alternatively, if you are starting from scratch, check out our
https://gruntwork.io/guides/compliance/how-to-achieve-cis-benchmark-compliance/[How to achieve compliance with the CIS AWS Foundations Benchmark]
guide instead.

=== Previous versions of this guide
- https://gruntwork.io/guides/upgrades/how-to-update-to-cis-13/[How to update to CIS AWS Foundations Benchmark v1.3.0]

=== What you'll learn in this guide

This guide consists of two main sections:

<<core_concepts>>::
An overview of the CIS AWS Foundations Benchmark v1.4.0 and why it is important to update your code for compatibility.

<<deployment_walkthrough>>::
The steps you need to take to update your code to be compliant with v1.4.0. It includes a
<<compatibility_table,version compatibility table>> you can use as a reference to know which Gruntwork Repo version
tag is compatible along with the manual steps you need to perform to achieve compliance with version 1.4.0 of the CIS
AWS Foundations Benchmark.


[[core_concepts]]
== Core Concepts

=== Background
Version 1.4.0 of the CIS AWS Foundations Benchmark was released in May of 2021. You can refer to the https://www.cisecurity.org/benchmark/amazon_web_services/[CIS website] where you can download the latest version of the Benchmark (as well as all the previous versions). The latest version introduces a few new recommendations, and also updates one recommendation. This guide will walk you through implementing these using Gruntworkâ€™s Infrastructure as Code Library so that your AWS infrastructure is fully compliant with version 1.4.0 of the framework.

==== Changes in recommendations
Changes in recommendations (both additions and removals) are listed below. You can think of these as a "diff"
between versions 1.3.0 and 1.4.0.

===== New recommendations
These are the new recommendations introduced in version 1.4.0 of the benchmark:

- 2.1.3: Ensure MFA Delete is enabled on S3 buckets
- 2.1.4: Ensure all data in Amazon S3 has been discovered, classified and secured when required
- 2.3.1: Ensure that encryption is enabled for RDS Instances

===== Updated recommendations
Version 1.4.0 also updated a recommendation. It only affects the IAM password policy:

- 1.12: Ensure credentials unused for 45 days or greater are disabled. The previous recommendation required credentials older than 90 days to be disabled.

==== New Gruntwork modules vs. existing modules
To achieve compliance with the new version of the benchmark, we created one new module in the
Gruntwork's Infrastructure as Code Library, and updated a bunch of existing modules. Recommendation 2.1.4
required creating a new module whereas the rest of the recommendations were achieved by updating existing modules.

To ensure compliance with version 1.4.0 of the CIS AWS Foundations Benchmark, you'll need to follow all the
instructions in the <<deployment_walkthrough>> section below; precisely, follow Steps 1 and 2 to ensure that
the existing modules get updated to their CIS AWS v1.4.0 compliant versions and follow Step 3 to ensure that you deploy and
configure the newly created modules.

[[deployment_walkthrough]]
== Deployment walkthrough

=== Step 1: Update references to the Gruntwork Infrastructure as Code Library

To update to the CIS AWS Foundations Benchmark v1.4.0, you need to update your references to the Gruntwork
Infrastructure as Code Library to use compatible versions. We (Gruntwork) have reviewed and updated all the library
modules for compatibility with the new version of the benchmark. As a customer, you need to update to
the proper versions of the Gruntwork library to pick up the fixes/changes made to be compatible. Refer to
https://gruntwork.io/guides/foundations/how-to-use-gruntwork-infrastructure-as-code-library/#updating[the
"Updating" section of "How to use the Gruntwork Infrastructure as Code Library"] for instructions on how to update the
versions in your code.

[.exceptional]
IMPORTANT: Gruntwork follows
https://gruntwork.io/guides/foundations/how-to-use-gruntwork-infrastructure-as-code-library/#versioning[semantic
versioning]. For any pre-1.0 modules, this means that version updates to the minor version are considered backward
incompatible releases for any version updates before the 1.0.0 release. Make sure to read the release notes for the
relevant modules any time you are updating minor versions! Note that you will want to read the release notes for each
minor version that is updated (e.g., if you are going from v0.5.x to v0.9.x, you will want to read the notes for v0.6.0,
v0.7.0, v0.8.0, and v0.9.0 to get the full list of backward incompatible updates).

The following table provides a summary of all the relevant Gruntwork AWS modules and the respective versions that are
compatible with CIS AWS v1.4.0:

[[compatibility_table]]
[cols="1,1h,1"]
|===
|Gruntwork Repo |Minimum version with CIS AWS v1.4.0 support |Corresponding CIS AWS v1.4.0 recommendations

|terraform-aws-security
|https://github.com/gruntwork-io/terraform-aws-security/releases/tag/v0.54.0[v0.54.0]
|1.12, 2.1.3, 2.1.4, 2.3.1
|terraform-aws-cis-service-catalog
|https://github.com/gruntwork-io/terraform-aws-cis-service-catalog/releases/tag/v0.27.0[v0.27.0]
|TODO

|===

=== Step 2: Deploy the new module

==== Deploy the Macie module (recommendation 2.1.4)
The new CIS AWS v1.4 recommendation 2.1.4 requires that all data in Amazon S3 be discovered, classified and secured.
One way to achieve this is the by leveraging the link:https://aws.amazon.com/macie/[Amazon Macie] service.
Amazon Macie is a fully managed data security and  data privacy service that uses machine learning and pattern matching
to discover and protect your sensitive data in AWS. To help you achieve this recommendation, we have created a dedicated
link:https://github.com/gruntwork-io/terraform-aws-cis-service-catalog/tree/master/modules/security/macie[`macie` service]
in our CIS service catalog.

NOTE: Manual steps required! After deploying the `macie` module as described below, make sure you perform the manual steps
outlined in the <<macie_manual_steps>> section.

To deploy the new `macie` module, create a wrapper module such as this:

.main.tf
[source,hcl]
----
module "macie" {
  source = "git::git@github.com:gruntwork-io/terraform-aws-cis-service-catalog.git//modules/security/macie?ref=v0.27.0"

  providers = {
    aws              = aws.default
    aws.eu_central_1 = aws.eu_central_1
    aws.eu_west_1    = aws.eu_west_1
    # ... more providers
  }

  buckets_to_analyze = {
    "eu-central-1" : ["my-bucket-in-eu-central-1"],
    "eu-west-1" : ["my-bucket-in-eu-west-1"]
  }

  # ... more configuration parameters
}
----

Since `macie` is a multi-region module that uses the new provider-based multi-region approach, you'll also need to provide
a `providers.tf` file, such as this:


.providers.tf
[source,hcl]
----
# Default provider
provider "aws" {
  region = var.aws_region
  alias  = "default"
}

# Configure a provider for each region
provider "aws" {
  region = "eu-central-1"
  alias  = "eu_central_1"

  # Skip credential validation and account ID retrieval for disabled or restricted regions
  skip_credentials_validation = contains(coalesce(var.opt_in_regions, []), "eu-central-1") ? false : true
  skip_requesting_account_id  = contains(coalesce(var.opt_in_regions, []), "eu-central-1") ? false : true
}

provider "aws" {
  region = "eu-west-1"
  alias  = "eu_west_1"

  # Skip credential validation and account ID retrieval for disabled or restricted regions
  skip_credentials_validation = contains(coalesce(var.opt_in_regions, []), "eu-west-1") ? false : true
  skip_requesting_account_id  = contains(coalesce(var.opt_in_regions, []), "eu-west-1") ? false : true
}

# ... more provider configurations
----

You'll also need to make sure you're providing a value for the `opt_in_regions` variable in your `variables.tf` file:
.variables.tf
[source,hcl]
----
variable "opt_in_regions" {
  description = "Creates resources in the specified regions. This variable must NOT be set to null or empty. Otherwise, we won't know which regions to use and authenticate to, and may use some not enabled in your AWS account (e.g., GovCloud, China, etc). To get the list of regions enabled in your AWS account, you can use the AWS CLI: aws ec2 describe-regions."
  type        = list(string)
  default     = ["eu-central-1", "eu-west-1"]
}

# ... more variables
----

For a fully functioning example, see the
link:https://github.com/gruntwork-io/terraform-aws-cis-service-catalog/tree/master/examples/for-learning-and-testing/security/macie[relevant example code in the CIS service catalog repo].

For more information about the new multi-region approach, see the
link:https://github.com/gruntwork-io/terraform-aws-cis-service-catalog/releases/tag/v0.25.0[release notes of the relevant release of the CIS service catalog].


=== Step 3: Manual steps

==== Enable MFA Delete

Enabling MFA Delete in your bucket adds another layer of security by requiring MFA in any request to delete a version or change the versioning state of the bucket.

The attribute `mfa_delete` is only used by Terraform to https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/s3_bucket#mfa_delete[reflect the current state of the bucket]. It is not possible to create a bucket if the `mfa_delete` is `true`, because it needs to be activated https://docs.aws.amazon.com/AmazonS3/latest/userguide/MultiFactorAuthenticationDelete.html[using AWS CLI or the API].

To make this change https://docs.aws.amazon.com/general/latest/gr/root-vs-iam.html#aws_tasks-that-require-root[**you need to use the root user of the account**] that owns the bucket, and MFA needs to be enabled.

[.exceptional]
IMPORTANT: We do not recommend having active AWS access keys for the root user, so remember to delete them when you finish this step.

In order to enable MFA Delete, you need to:

1. https://docs.aws.amazon.com/IAM/latest/UserGuide/id_root-user.html#id_root-user_manage_add-key[Create access keys for the root user]
1. https://docs.aws.amazon.com/IAM/latest/UserGuide/id_root-user.html#id_root-user_manage_mfa[Configure MFA for the root user]
1. Create a bucket with `mfa_delete=false`.
1. Using the root user, call the AWS CLI to enable MFA Delete. If you are using `aws-vault`, it is necessary to use the `--no-session` flag.
+
[source,bash]
----
aws s3api put-bucket-versioning --region <REGION> \
    --bucket <BUCKET NAME> \
    --versioning-configuration Status=Enabled,MFADelete=Enabled \
    --mfa "arn:aws:iam::<ACCOUNT ID>:mfa/root-account-mfa-device <MFA CODE>"
----
+
1. Set `mfa_delete=true` in your Terraform code
1. Remove any Lifecycle Rule that the bucket might contain (for the `aws-config-bucket` and `cloudtrail-bucket` modules, enabling `mfa_delete` will already disable the lifecycle rules).
1. Run `terraform apply`.
1. If there are no S3 buckets remaining to enable MFA Delete, delete the access keys for the root user, but be sure to **leave MFA enabled**.

We also created a script to help you enable MFA Delete in all buckets from a single account at once.

**TODO - add link to the script and instructions**

===== Using mfa-delete.sh

If you want to enable MFA Delete to _all_ your buckets at once, you can use the script at https://github.com/gruntwork-io/terraform-aws-security/tree/master/modules/private-s3-bucket[terraform-aws-security/private-s3-bucket/mfa-delete-script]. You need to use the access keys for the root user and the root MFA code.

Usage:
```
aws-vault exec <PROFILE> --no-session -- ./mfa-delete.sh --account-id <ACCOUNT ID>
```

Example:
```
aws-vault exec root-prod -- ./mfa-delete.sh --account-id 226486542153
```


[[macie_manual_steps]]
==== Configure Amazon Macie
===== Configure bucket to store sensitive data discovery results
To deploy the Macie module and configure it for CIS compliance, certain manual steps are needed. Namely, configuring the
S3 bucket to be a repository for the sensitive data discovery results is
link:https://github.com/hashicorp/terraform-provider-aws/issues/19856[currently not supported] in the terraform AWS
provider, so you'll need to do it manually. After deploying the module using `terraform apply`, you need to run the following manual steps:

1. Log into the AWS console and for every region, repeat the steps 2 to 9.
1. Go to the Amazon Macie service.
1. In the left pane, under Settings, click on "Discovery results".
1. Click on "Configure now" to configure an S3 bucket for long-term retention of sensitive data discovery results.
1. Choose "Existing bucket".
1. Under "Choose a bucket", select your bucket. This can be either one you already have, or the one that the `macie` module created. You will use the same bucket for every region.
1. Under "KMS encryption" choose "Select a key from your account".
1. Under "KMS key alias" select your KMS key. This can be either one you had already have, or the one that the `macie` module created. You will use the same key for every region.
1. Click "Save".

Once the above issue in the Terraform AWS provider has been resolved, we will
link:https://github.com/gruntwork-io/terraform-aws-cis-service-catalog/issues/205[update the Gruntwork macie module]
so that it completely automates all the steps of configuring Amazon Macie, and no manual steps will be required any longer.

===== Manually maintain buckets to analyze in the `buckets_to_analyze` variable
When creating a Macie classification job, you need to specify a list of buckets that should be analyzed. Typically,
you'll want to analyze all the buckets in the region. However, the terraform AWS provider does not support specifying
all the buckets in a region - it requires that an explicit list of buckets be provided (see related bug
link:https://github.com/hashicorp/terraform-provider-aws/issues/20044[here]). Therefore, you'll need to maintain an
explicit list of buckets per region, namely in the variable `buckets_to_analyze`. Please read the
link:https://github.com/gruntwork-io/terraform-aws-cis-service-catalog/blob/master/modules/security/macie/variables.tf#L21-L30[documentation]
for this variable in order to understand how to structure the list of buckets per region. Once the above issue in the
terraform AWS provider has been resolved, we will
link:https://github.com/gruntwork-io/terraform-aws-cis-service-catalog/issues/204[update the Gruntwork macie module]
to add support for specifying all buckets in a region.


== Finally
And that's all, fellow Gruntworkers.

This guide is meant to help you get your AWS infrastructure from CIS 1.3.0 to CIS 1.4.0 using our dedicated and up-to-date modules. While we try to automate as much as possible, some of the steps are still manual. We hope that the guide above clearly details what needs to be done, and how.

If you've got any feedback or you think something's missing from the guide, please get in touch via link:https://github.com/gruntwork-io/gruntwork-io.github.io[Github], or our dedicated link:https://gruntwork.io/contact[Contact Us] page.
