---
title: How to build and deploy a bastion host for your production-grade system on AWS
categories: Networking
image: /assets/img/guides/aws-account/aws-logo.png
excerpt: Learn how to deploy a secure bastion host for your production system on AWS.
tags: ["aws", "networking", "terraform"]
cloud: ["aws"]
redirect_from: /static/guides/networking/how-to-deploy-production-grade-bastion-host-aws/
---
:page-type: guide
:page-layout: post

:toc:
:toc-placement!:

// GitHub specific settings. See https://gist.github.com/dcode/0cfbf2699a1fe9b46ff04c41721dda74 for details.
ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
toc::[]
endif::[]

== Intro

If you were following the https://gruntwork.io/guides/networking/how-to-deploy-production-grade-vpc-aws[Gruntwork guide on how to deploy a production grade VPC on AWS], then you probably came across https://gruntwork.io/guides/networking/how-to-deploy-production-grade-vpc-aws/#bastion_host[the section talking about bastion hosts].

When deploying your infrastructure in AWS or any of the other main cloud providers, you might need to keep some of those resources protected and safe from the hands of malicious external actors. Therefore, we recommend keeping your data stores and application servers in a private network (see the https://gruntwork.io/guides/networking/how-to-deploy-production-grade-vpc-aws/#multiple_subnets[production-grade VPC guide]).

While this might depend on your system architecture in place, such a network design is great for limiting the impact of an eventual harmful event, and also helps you control access to the most sensitive parts of your system. To achieve this, you will need some way of determining if the incoming traffic to your private network is to be trusted or not. And one of the ways is to deploy a bastion host.

The guide below will guide you through what is a bastion host, when to use it, some core concepts, and finally - what's the process of configuring a production-grade bastion host and deploying it to AWS.

=== What you'll learn in this guide

This guide consists of four main sections:

<<core_concepts>>::
  An overview of the core concepts you need to understand for bastion hosts and how and when to use them.

<<production_grade_design>>::
  An overview of how to configure a secure server to serve as a bastion host in a production environment. To get a
  sense of what production-grade means, check out link:/guides/foundations/how-to-use-gruntwork-infrastructure-as-code-library#production_grade_infra_checklist[The production-grade infrastructure checklist].

<<deployment_walkthrough>>::
  A step-by-step guide to deploying a production-grade bastion host in AWS using code from the Gruntwork Infrastructure as Code Library.

<<next_steps>>::
  What to do once your bastion host is configured and set up.

Feel free to read the guide from start to finish or skip around to whatever part interests you!

[[core_concepts]]
== Core concepts

=== Networking setup overview
Before we start getting into what a <<bastion_host>> is and how to deploy and configure one, let's take a step back and define some fundamental concepts around secure networking.

In both physical and virtual networks, the idea of internal and public-facing networks exist. Public networks, as their name suggests are public to the world, and thus the Internet. That means anyone connected to the Internet, will be able to see and exchange data with the devices on that network.

Private networks, on the other hand, are mostly used to restrict access to a group of devices and enable data to be  transmitted only within the constraints of the netwrok and teh devices in it. Depending on the network configuration, devices _on_ the network will be able to communicate with each other, but external actors and devices will not be able to talk to the devices in that internal network. usually that can be achieved using additional network devices such as firewalls.

Sometimes of course, there legitimate needs for external clients to access the private subnet and communicate with the devices on the private network. In those cases, solutions such as SSH, VPN, Telnet, RDP and others exist. These protocols are all ways of communication that allow external devices to authenticate to the internal network and communicate as if the they're originally part of that network.

If you'd like to learn more about networks and public and private subnetc, we recommend starting with the link:https://gruntwork.io/guides/networking/how-to-deploy-production-grade-vpc-aws#subnets[Gruntwork guide on VPCs].

Below we'll dive in to each separate protocol and network term and explan briefly what they're doing and what they're best for.

[[ssh]]
=== SSH
SSH is the name for the Secure Socket Shell network protocol, which enables its users to access securely a device or computer via an unsecured (usually public) network. SSH is also the name of the tool that implements SSH protocol and allows its users not only to authenticate to a remote machine securely, but also transmit data and execute commands on the remote device, fully end-to-end encrypted, using Public Key Infrastructure (PKI).

The protocol has been designed in a way that it lets users authenticate to a device placed in an external network (usually that's a private network) over the Internet, by providing some credentials or SSH keys. The SSH keys are a cryptographic key pair (PKI) that can be configured on the server and the client so that the connection is allowed. For example, a public key pair is generated, and the public key is placed on the server, so it knows who to allow access to. The private key is kept with the device or user that needs to access the server. When the client requests a connection to another end device (the SSH server), the SSH server responds by asking for the private key of the public key pair. The client has to prove that it's got the private key to that public-private key pair. Once the client is authenticated and the connection is established, the client will keep sending the hashed value of the private key along with the data. This means that the SSH protocol not only offers strong authentication, but also strong end-to-end encryption and integrity. If you'd like to learn more about how the Public Key Infrastructure works, or the SSH protocol, this is a good reading resource: link:https://www.ssh.com/academy/pki[PKI], link:https://www.ssh.com/academy/ssh/protocol[SSH protocol].

SSH is widely used in the world of cloud technologies, especially since it's automatable. One of the way AWS offers you to connect to an EC2 instance is also based on SSH - link:https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/Connect-using-EC2-Instance-Connect.html[EC2 Instance Connect].

Typically you'll use SSH as follows:

[source,bash]
----
## Generating SSH PKI pair
# ssh-keygen -t <ENCRYPTION ALGORITHM> -b <BITS> -C <A COMMENT TO DIFFERENTIATE THE KEY PAIR>
ssh-keygen -t rsa -b 4096 -C <your_username>
----

[source,bash]
----
## Using SSH to authenticate to a server
ssh <your_username>@<server_ip_adress_you_are_connecting_to>
----

==== ssh-grunt

At Gruntwork we use SSH daily, and thus we've designed a module dedicated to SSH. The link:https://github.com/gruntwork-io/terraform-aws-security/tree/master/modules/ssh-grunt[`ssh-grunt`] module is designed to help you configure and deploy a Linux server to help you manage SSH access via an external Identity provider (IdP). It uses the link:https://aws.amazon.com/iam/[IAM] service to read the IAM users' SSH keys added to their accounts and allow them to SSH to your servers.

While SSH is considered really secure, the biggest threat to it is the private key being exposed. What that means is whoever's got access to the private SSH key, or the IAM user with the private SSH key, can essentially alter the settings for the SSH server, and add explicit access just for their malicious purposes. Therefore, we recommend always setting up MFA (multi-factor authentication) for all users, especially IAM users in IAM. For more details on the threats for ssh, check link:https://github.com/gruntwork-io/terraform-aws-security/blob/master/modules/ssh-grunt/core-concepts.md#threats-from-an-ssh-compromise[this Readme out].

Once you've got SSH Grunt in place, you'll be using `ssh` exactly in the same way as you know already. The difference is that now this user is linked to the IAM user you have in AWS, and the SSH key that has been linked to that IAM user too.

[source,bash]
----
## Using SSH to authenticate to a server
ssh <your_username>@<server_ip_adress_you_are_connecting_to>
----

To learn more about the `ssh-grunt` module and see examples of how to deploy it and use for your infrastructure, check out the code here link:https://github.com/gruntwork-io/terraform-aws-security/tree/master/modules/ssh-grunt[here].

[.exceptional]
IMPORTANT: You must be a [js-subscribe-cta]#Gruntwork IaC Library subscriber# to access some of the Gruntwork
Infrastructure as Code Library modules.

[[vpn]]
=== VPN
VPN is another widely popular practice in the tech and cloud industry. It stands for a Virtual Private Network, and it essentially creates a secure tunnel from your private network to a public network over the Internet. It enables its users to exchange data and communicate as if they were on the same private network.

VPN is built relying on a few different protocols, each having a slightly augmented benefit - e.g. PPTP is one of the first VPN protocols used, but it has now become obsolete, due to its broken encryption. Since then, VPN over L2TP/IPSec is preferred for more enterprises and businesses due to its reliability - it's a combination of two separate protocol L2TP, which enables the tunneling of the connection, and IPSec which adds strong end-to-end encryption.

Finally, there's an open-source protocol implementation for VPN, which is widely used amongst developers, since the access to the code is open, and a lot of - link:https://community.openvpn.net/openvpn[OpenVPN]. It is also considered to be a very secure VPN protocol, since it uses the still unbroken encryption algorithm AES-256, RSA authentication and hashing. The most important part of this VPN protocol is that it's open-source, which has led to a big community of support, auditing and improvements to the protocol, making it even more secure and reliable.

At Gruntwork, we're using OpenVPN heavily for our own VPN setup. We've created a module for that, which is exactly what this guide will be taking us through in detail shortly in the Deployment Walkthrough section. If you're in a hurry and want to see the code straightaway, please check out our link:https://github.com/gruntwork-io/terraform-aws-openvpn[`terraform-aws-openvpn` dedicated repository] with examples and modules you can refer to.

[.exceptional]
IMPORTANT: You must be a [js-subscribe-cta]#Gruntwork IaC Library subscriber# to access some of the Gruntwork
Infrastructure as Code Library modules.

There are many tools that provide VPN services too that you can use for free or their paid plans too. Check out NordVPN, Windscribe, Tunnelbear, ProtonVPN, ExpressVPN and link:https://www.wired.co.uk/article/best-vpn[see more].

[[other_security_tools_and_protocols]]
=== Other security protocols and tools
We don't yet support any of these other secure communication tools, but here's a brief overview of what's out there.

[[rdp]]
==== RDP
While SSH and VPN are most popular choices with Linux, Unix and MacOS users, and Windows users _also_ rely on these tools, there's another very popular protocol for Windows-based environments - RDP.

The Remote Desktop Protocol is similarly client-server based. It is different because it enables the client connecting to the RDP server to execute commands over the network _and_ see the server's display. This means the connection establishment is a bit heavier becasue more parameters have to be echanged between the client and server (e.g. core data such as display resolution, OS version, and etc., as well ac connection authentication).

The RDP is genrerally secured by using techniques such as network level authentication (e.g. IP whitelisting), and strong firewall policies. Some of the more popular implementations of this protocol are TeamViewer and the native Windows Remote Desktop Connection.

[[vnc]]
==== VNC
VNC (Virtual Network Computer) is yet another popular tool to enable graphic user interface sharing (E.g. using VNC the client will be able to see the other machines's desktop). It transmits encrypted data for the keyboard and mouse movements on your computer and updates the graphical interface on the other end. Most importantly unlike RDP, it works well cross-platform, and thus may be preferred for businesses with multiple operating systems.

[[telnet_]]
==== Telnet, FTP and more
There's more application and network protocols for data and file sharing such as Telnet, SMB (Server Messaging Block), FTP(file transfer protocol), and many more. Some of them are not as preferred or popular due to unreliability and lack of encryption in the connection establishment and data transfer after. Telnet does not use any encryption, so it transmits passwords and sensitive data in plain text. And so does FTP, although there's strong authentication implementations of FTP - called SFTP (using SSH) and FTPS (using SSL). You can read more about this link:https://www.goanywhere.com/blog/2011/10/20/sftp-ftps-secure-ftp-transfers[here].

[[bastion_host]]
=== Bastion server
So now that we've covered some generic concepts of why it is important to have separation of subnets and their access, as well as protocols that support access even if the network is split into private and public subnets, we can move on to the topic of bastion hosts. In the next sections we'll cover what exactly a Bastion host is, why we need it and how it fits into the above-explained concepts.

==== What is a bastion server (host)?
The word "bastion" was originally coined as a term in network security in 1990 by Marcus J. Ranum. Many centuries before that, the name bastion was used to describe a projecting part of a fortification, designed in such a way to offer maximum defenses from multiple angles. So the word "bastion" has been used as a security or protective term in a long time.

In the technical world, the term _bastion host (or server)_ is founded on this concept too: It is a dedicated single server built and configured in a highly-secured way in order to allow only specific access to internal resources. Clients can connect to the bastion host only via SSH or VPN, and once authenticated, they can then talk to the resources that the bastion host can also talk to.

In general, bastion servers are useful when users from one network want to use or communicate with a device on another private network. The only way this can be achieved is by using some of the above-mentioned protocols, unless the devices are both in the same network. A bastion server can be placed in the public network, and be open to the world (e.g. if placed in a DMZ zone), or it can be placed behind a firewall, so access to it is also controlled.

In AWS infrastructure, you'll mostly find the bastion server being placed in a public-facing network of a VPC. It will be there to provide a single entry point to some of the more inner-facing resources that may be placed in the private or the persistenace subnet: link:https://gruntwork.io/guides/networking/how-to-deploy-production-grade-vpc-aws#subnets[Gruntwork guide on VPCs].

As every cloud resource within your AWS estate, it is best to ensure that the bastion server is also well-secured and follows all security best practices. This way it helps minimize the risk of penetration to the resources launched in your public and private subnets within your Amazon Virtual Private Cloud (VPC). For more details, please refer to https://aws.amazon.com/blogs/security/how-to-record-ssh-sessions-established-through-a-bastion-host/[AWS's security blog].

==== Why do you need a bastion host?

A bastion server is considered to be one of the security best practices, especially when it comes to the cloud and AWS. It is very popular as a solution, because of the benefits it brings in comparison to the risks it helps you mitigate.

To illustrate best why a bastion host is so useful from a security standpoint, let's consider this example:

You have a webapp that processes some personal data. The system architecture consists of a public-facing EC2 instance, or something equivalent (in case you're using containerised solutions), and a database that is located in a private subnet and only allows traffic/access from the public EC2 instance(read https://gruntwork.io/guides/networking/how-to-deploy-production-grade-vpc-aws/#multiple_subnets[our guide on the multiple subnets for a production-grade VPC]). Now you need your developers to be able to log in the database server and run some updates. For them to be able to connect to your database, it needs to be publicly accessible, or your developers need to be somehow on the internal network.

This is where a bastion host comes in extremely handy. It can be placed in your public network, where you've got access restricted for everyone but your office network and specific IP addresses. The bastion host is explicitly whitelisted in your private network and database security groups. This would allow your developers to log in only from your office network to the bastion host, and use it to access resources on the private network.

Another benefit of having a bastion host in this scenario, is that you control who and when gets access to it. For example, the bastion server can be authenticated to only in certain timezones, or be turned off in most times, unless there's a live urgent issue to debug and access to the private network is indeed necessary. Once the incident is resolved, you could simply turn off the bastion host, and all access to it will be ceased. Which means in its turn, access to the private services with sensitive and highly confidential data is no longer accessible by the developers, or anyone else.

=== Does the bastion server need securing too?
Having a bastion server and a well-designed VPC is always a good start for securing your network. As all other servers and entry points in your system, we'll want to keep your bastion server up to date, secure and monitored. A bastion host is a vulnerable part of your system, especially with it being an entry point into your system that you want external users to be aware of, espcially in cases of system emergency. Let's review some server-hardening techniques and best security recommendations to help you keep any server, most of all, a bastion server secure and reliable.

[[bastion_hardening]]
=== Server hardening for a bastion server
_Server hardening_ is the process of enhancing a server's security by applying best brastices to limit the impact of vulnerabilties and possible attacks. Below we will present some recommendations based on our own experience, however, we also strongly recommend that you expand your knowledge by reading link:https://medium.com/@sysrex/my-first-10-minutes-on-a-server-d79ea273809b[My First 10 Minutes on a Server] article and other best practices you can find.

1. OS and user permissions
Whether you're working on a physical server, or your bastion server is deployed on AWS, you shouldn't use the root user of the OS, nor the root user of your AWS account. This is because it's the most powerful user and account owner, which means if you use it for ordinary operations, you're exposing the user and therefore the system to the vulnerabilities and threats that inevitably surround any system.
2. The user you have to manage your bastion server should not be the same as the AWS root user.
3. Block any protocols, ports and IP addresses that you're not expecting a connection from. For example, if your bastion server is on youw AWS production environment, you might only ever expect connections to it from within your headquarter's office. Therefore, use security groups, firewalls and network access control lists to limit who can see and communicate with the bastion server, and when.
4. Follow the least-privilege rule on every level. Your bastion server should only have access to what is necessary from there. Your system administrator IAM users should only have access to what lies within their responsibilities.
Just as you shouldn’t use the root user for anything in an AWS account, you also shouldn’t use the root user for anything on your OS.
5. We recommend using ports on your bastion server that you explicitly need. For example, on a webserver you might need ports 80 and 443 running, but on a bastion server, you might want only port 22 - used for SSH connections.
6. When you're configuring who can access your bastion server, make sure you use separate user accounts for each user - separate public and private keys for all of them. It is not a good idea to share ssh keys across multiple users, so educate your users and developers on this too. We recommend using `ssh-grunt` to allow you to sync IAM users and SSH keys to the users on your bastion box.
7. Disable password-based SSH authentication on your bastion box.
8. If you're using the VPN `terraform-aws-openvpn` module, make sure to follow the recommendations on the repository itself for best practices.
9. Make sure your bastion server is kept up-to-date with the latest security patches. That goes for the OS patches (check out the Gruntwork link:https://github.com/gruntwork-io/terraform-aws-security/tree/master/modules/auto-update[auto-update module]) and the tools and software run on the server.
10. Review periodically what software is running and enabled on your bastion host. You might want to run modifed versions of the software, so they're more restrictive and secure, or that you run only the essential software tools you need.
11. Consider whether you actually need a bastion box in the infrastructure - e.g. the bastion server approach is most beneficial when you don't have direct access to production networks, or live critical systems. However, in your day-to-day development and test environments, you might not need the same approach, and sufficient monitoring and logging could be enough.
12. Enable monitoring, logging and alarms for your system and AWS infrastructure. It helps you increase the reliability of your system tremendously by showing you what's going on and debug problems faster. Check out the link:https://github.com/gruntwork-io/terraform-aws-monitoring[Gruntwork modules for this].

[.exceptional]
IMPORTANT: You must be a [js-subscribe-cta]#Gruntwork IaC Library subscriber# to access some of the Gruntwork
Infrastructure as Code Library modules.

Best security practices are difficult to put in place, since every system is very individual and has different requirements. A few notable practices are:
- keeping up to date with the latest vulnerabilities and attacks;
- keeping your access control policies and identity management under control;
- configuring your servers, network and data stores in a secure way.

For generic guidance and example, please read through the guide document that we've published on link:https://docs.google.com/document/d/1EgbaK7z322hk0Nc-7oZeaemkNYTScQJx1byNqrMcSqI[Security Best Practices].

If you'd like to learn about best security pratices and recommendations for AWS, please refer to link: https://docs.aws.amazon.com/security[AWS's official documentation].

[[deployment_walkthrough]]
== Deployment walkthrough

Let's now walk through how to deploy a production-grade server that will be our bastion host, fully defined and managed as code, using the Gruntwork Infrastructure as Code Library.

//TODO add your code

[[pre_requisites]]
=== Pre-requisites

This walkthrough has the following pre-requisites:

Gruntwork Infrastructure as Code Library::
  This guide uses code from the https://gruntwork.io/infrastructure-as-code-library/[Gruntwork Infrastructure as Code Library], as it
  implements most of the production-grade design for you out of the box. Make sure to read
  link:/guides/foundations/how-to-use-gruntwork-infrastructure-as-code-library[How to use the Gruntwork Infrastructure as Code Library].
+
[.exceptional]
IMPORTANT: You must be a [js-subscribe-cta]#Gruntwork subscriber# to access the Gruntwork Infrastructure as Code Library.

Terraform::
  This guide uses https://www.terraform.io/[Terraform] to define and manage all the infrastructure as code. If you're
  not familiar with Terraform, check out https://blog.gruntwork.io/a-comprehensive-guide-to-terraform-b3d32832baca[A
  Comprehensive Guide to Terraform], https://training.gruntwork.io/p/terraform[A Crash Course on Terraform], and
  link:/guides/foundations/how-to-use-gruntwork-infrastructure-as-code-library[How to Use the Gruntwork Infrastructure as Code Library]

AWS accounts::
  This guide deploys infrastructure into one or more AWS accounts. Check out the
  link:/guides/foundations/how-to-configure-production-grade-aws-account-structure[Production Grade AWS Account Structure] guide for instructions.
  You will also need to be able to authenticate to these accounts on the CLI: check out
  https://blog.gruntwork.io/a-comprehensive-guide-to-authenticating-to-aws-on-the-command-line-63656a686799[A Comprehensive Guide to Authenticating to AWS on the Command Line]
  for instructions.

[[deploy_bastion_server]]
=== Deploy a bastion server

For this part we will be deploying one of our core module https://github.com/gruntwork-io/terraform-aws-server/blob/master/modules/single-server[`single-server module`].
